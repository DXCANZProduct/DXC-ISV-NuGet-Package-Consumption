name: $(Year:yyyy).$(Month).$(DayOfMonth)$(Rev:.r)

trigger:
- none

jobs:
- job: PullDXCISVNugetPackages
  displayName: 'Pull DXC ISV Nuget Packages'
  timeoutInMinutes: 360
  pool:
    vmImage: 'windows-latest'
  steps:
  #Authenticate connection with DXC Artifact feed
  - task: NuGetAuthenticate@1
    displayName: 'Authenticate connection with DXC Artifact Feed'
    inputs:
      nuGetServiceConnections: 'SERVICE CONNECTION'

  #Restore Packages from DXC Artifact feed
  - task: NuGetCommand@2
    displayName: 'Restore Packages from DXC Artifact Feed'
    inputs:
      command: 'restore'
      restoreSolution: 'packages.config'
      feedsToUse: 'config'
      nugetConfigPath: 'nuget.config'
      restoreDirectory: 'packages'
      
  #Update Packages to latest versions
  # - task: NuGetCommand@2
  #   displayName: 'Update Packages to latest version'
  #   inputs:
  #     command: 'custom'
  #     arguments: 'update packages.config -RepositoryPath packages -Verbosity Detailed -NonInteractive -ConfigFile nuget.config -FileConflictAction Ignore'

  #Push Packages into local feed
  - task: NuGetCommand@2
    displayName: 'Push Packages into local feed'
    inputs:
      command: 'push'
      packagesToPush: 'packages/DXC*/*.nupkg'
      nuGetFeedType: 'internal'
      publishVstsFeed: 'TARGET FEED'
      publishPackageMetadata: false
      allowPackageConflicts: true

  #Delete files and packages
  - task: DeleteFiles@1
    displayName: 'Clean source folder'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: '**/*'
